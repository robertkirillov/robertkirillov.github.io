<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Scanner</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; max-width: 720px; margin: 0 auto; }
    button { padding: 12px 16px; font-size: 16px; cursor: pointer; }
    #reader { width: 100%; max-width: 520px; margin-top: 16px; display: none; }
    #result { margin-top: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; word-break: break-word; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .muted { color: #666; font-size: 14px; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>QR Scanner</h1>

  <div class="row">
    <button id="startBtn">Scan QR code</button>
    <button id="stopBtn" style="display:none;">Stop</button>
  </div>

  <div class="muted">Tip: This works best on HTTPS (or localhost). iOS Safari requires HTTPS for camera access.</div>

  <div id="reader"></div>

  <div id="result" aria-live="polite">
    <strong>Result:</strong>
    <div id="resultText">—</div>
    <div id="actions" style="margin-top:10px; display:none;">
      <a id="openLink" href="#" target="_blank" rel="noopener">Open scanned URL</a>
    </div>
  </div>

  <!-- QR scanning library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const readerEl = document.getElementById("reader");
    const resultText = document.getElementById("resultText");
    const actions = document.getElementById("actions");
    const openLink = document.getElementById("openLink");

    const isProbablyUrl = (text) => {
      try {
        const u = new URL(text);
        return u.protocol === "http:" || u.protocol === "https:";
      } catch {
        return false;
      }
    };

    let qr; // Html5Qrcode instance
    let isRunning = false;

    async function startScan() {
      if (isRunning) return;

      // Create the scanner instance (uses a div as the render target)
      qr = new Html5Qrcode("reader");

      readerEl.style.display = "block";
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      resultText.textContent = "Point your camera at a QR code…";
      actions.style.display = "none";
      openLink.href = "#";

      const config = {
        fps: 10,
        qrbox: { width: 260, height: 260 },
        // You can also set: aspectRatio: 1.0
      };

      try {
        isRunning = true;
        await qr.start(
          { facingMode: "environment" }, // back camera
          config,
          (decodedText) => {
            // SUCCESS callback
            resultText.textContent = decodedText;

            if (isProbablyUrl(decodedText)) {
              openLink.href = decodedText;
              actions.style.display = "block";
              // Optional: auto-open
              // window.open(decodedText, "_blank", "noopener");
            } else {
              actions.style.display = "none";
            }

            // Optional: stop after first successful scan
            stopScan();
          },
          (errorMessage) => {
            // ERROR callback (ignore noisy scan errors)
          }
        );
      } catch (err) {
        isRunning = false;
        readerEl.style.display = "none";
        startBtn.style.display = "inline-block";
        stopBtn.style.display = "none";
        resultText.textContent = "Camera error: " + (err?.message || err);
      }
    }

    async function stopScan() {
      if (!qr || !isRunning) return;
      try {
        await qr.stop();
        await qr.clear();
      } finally {
        isRunning = false;
        readerEl.style.display = "none";
        startBtn.style.display = "inline-block";
        stopBtn.style.display = "none";
      }
    }

    startBtn.addEventListener("click", startScan);
    stopBtn.addEventListener("click", stopScan);
  </script>
</body>
</html>
