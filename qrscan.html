<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>QR Scanner</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .wrap { max-width: 640px; margin: 0 auto; }
    button { padding: 12px 16px; font-size: 16px; border: 0; border-radius: 10px; cursor: pointer; }
    #scanBtn { width: 100%; }
    #stopBtn { width: 100%; margin-top: 10px; display: none; }
    #status { margin-top: 12px; opacity: 0.8; }
    #result { margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; word-break: break-all; }
    video { width: 100%; margin-top: 12px; border-radius: 14px; background: #000; }
    .hint { margin-top: 10px; font-size: 14px; opacity: 0.75; }
    a { color: inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 10px;">QR Scanner</h1>

    <button id="scanBtn">Scan</button>
    <button id="stopBtn">Stop</button>

    <div id="status">Press “Scan” to open the camera.</div>

    <video id="video" playsinline muted></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <div id="result" style="display:none;"></div>

    <div class="hint">
      Notes: Camera access requires <b>HTTPS</b> (GitHub Pages is HTTPS). On iPhone, make sure you allow camera permission when prompted.
    </div>
  </div>

  <!-- Fallback decoder for Safari/iOS and browsers without BarcodeDetector -->
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    const scanBtn  = document.getElementById("scanBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const video    = document.getElementById("video");
    const canvas   = document.getElementById("canvas");
    const ctx      = canvas.getContext("2d", { willReadFrequently: true });

    let stream = null;
    let running = false;
    let rafId = null;
    let detector = null;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function showResult(text) {
      resultEl.style.display = "block";
      // Make it clickable if it looks like a URL
      if (/^https?:\/\//i.test(text)) {
        resultEl.innerHTML = `Result: <a href="${text}" target="_blank" rel="noopener noreferrer">${text}</a>`;
      } else {
        resultEl.textContent = `Result: ${text}`;
      }
    }

    async function startCamera() {
      // Stop old session if any
      await stopScanning();

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus("getUserMedia is not supported in this browser.");
        return;
      }

      setStatus("Requesting camera permission…");

      // Prefer rear camera on phones
      const constraints = {
        audio: false,
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        // iOS Safari needs explicit play() after user gesture
        await video.play();

        running = true;
        stopBtn.style.display = "block";
        setStatus("Point the camera at a QR code…");

        // Use native detector when available (fast in Chrome)
        if ("BarcodeDetector" in window) {
          try {
            detector = new BarcodeDetector({ formats: ["qr_code"] });
          } catch (e) {
            detector = null; // some browsers expose it but fail constructing
          }
        } else {
          detector = null;
        }

        scanLoop();
      } catch (err) {
        console.error(err);
        setStatus("Camera permission denied or not available. " +
                  "If on iPhone: Settings → Safari → Camera (Allow) or check site permissions.");
      }
    }

    async function stopScanning() {
      running = false;
      detector = null;

      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }

      if (video) {
        video.pause();
        video.srcObject = null;
      }

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      stopBtn.style.display = "none";
    }

    async function scanLoop() {
      if (!running) return;

      try {
        // Wait until video has dimensions
        if (video.readyState >= 2 && video.videoWidth && video.videoHeight) {
          // Native BarcodeDetector path
          if (detector) {
            const barcodes = await detector.detect(video);
            if (barcodes && barcodes.length) {
              const value = barcodes[0].rawValue || barcodes[0].data || "";
              if (value) {
                showResult(value);
                setStatus("QR found ✅");
                await stopScanning();
                return;
              }
            }
          } else {
            // jsQR fallback path: draw frame -> decode
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "attemptBoth"
            });

            if (code && code.data) {
              showResult(code.data);
              setStatus("QR found ✅");
              await stopScanning();
              return;
            }
          }
        }
      } catch (e) {
        console.error(e);
        // Don’t hard-fail; keep trying
      }

      rafId = requestAnimationFrame(scanLoop);
    }

    scanBtn.addEventListener("click", startCamera);
    stopBtn.addEventListener("click", async () => {
      await stopScanning();
      setStatus("Stopped. Press “Scan” to start again.");
    });

    // Clean up if user navigates away / background
    window.addEventListener("pagehide", stopScanning);
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopScanning();
    });
  </script>
</body>
</html>
